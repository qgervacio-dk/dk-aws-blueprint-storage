name: Blueprin / Provisioner demo
on: [push]
jobs:
  run-all: # TODO
    runs-on: ubuntu-latest
    environment: test-mmi
    env:
      ENV: dev 
      REGION: ap-southeast-1
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: chrisdickinson/setup-yq@latest
      - uses: kishaningithub/setup-tf-summarize@v2
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7"
      - run: |
          yq -V
          tf-summarize -v
          terraform -v
      - run: |
          terraform init \
            -backend-config="bucket=tf-state-bprint-prov-sample" \
            -backend-config="key=tfstate/storage/$ENV" \
            -backend-config="region=$REGION"
          terraform workspace select $ENV || terraform workspace new $ENV
          yq --prettyPrint $ENV.terraform.tfvars.yaml -o=json > terraform.tfvars.json || exit 1
          terraform plan -out tfplan && terraform show -json tfplan | tf-summarize
          terraform apply --auto-approve
          terraform destroy --auto-approve
